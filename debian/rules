#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all reproducible=+all future=+lfs

# Bug in compilation https://github.com/dartsim/dart/issues/2294
export DEB_CFLAGS_MAINT_APPEND += -DNDEBUG=1
export DEB_CXXFLAGS_MAINT_APPEND += -DNDEBUG=1


# Needed to inject correctly the python versions supported
export PYBUILD_SYSTEM=cmake
export PYBUILD_CONFIGURE_ARGS=-DPYVER={version} \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DDART_VERBOSE=ON \
		-DDART_USE_SYSTEM_GOOGLETEST=ON \
		-DDART_BUILD_DARTPY=ON \
		-DDART_USE_SYSTEM_PYBIND11=ON

export PYBUILD_AFTER_INSTALL=cp {build_dir}/python/dartpy/dartpy.*.so debian/tmp/usr/lib/python3/dist-packages/dartpy/

ifneq (,$(filter $(DEB_HOST_ARCH),mips mipsel))
  export DEB_CXXFLAGS_MAINT_APPEND += -g1
endif

%:
	dh $@ --buildsystem=pybuild

execute_after_dh_auto_build:
	PYBUILD_BUILD_ARGS="dartpy" dh_auto_build
	PYBUILD_BUILD_ARGS="tests" dh_auto_build

execute_before_dh_auto_install:
	mkdir -p debian/tmp/usr/lib/python3/dist-packages/dartpy

execute_after_dh_auto_install:
	# Remove RPATH from Python module
	chrpath -d debian/tmp/usr/lib/python3/dist-packages/dartpy/dartpy.*.so || true
	rm -f debian/tmp/usr/share/doc/dart/data/screencap/.KEEP

# s390 assimp support is broken for STL https://github.com/assimp/assimp/issues/5509
ifeq ($(DEB_HOST_ARCH),s390x)
override_dh_auto_test:
	PYBUILD_TEST_ARGS="ARGS\+='-E test_MjcfParser\|test_SdfParser\|test_DartLoader\|test_IkFast\|test_ForwardKinematics'" \
		dh_auto_test
else
override_dh_auto_test:
	PYBUILD_TEST_ARGS="ARGS\+='--timeout 2000'" dh_auto_test
endif

override_dh_compress:
	dh_compress \
            -X.hpp -X.h -X.c -X.cpp \
            -X.dae -X.obj -X.stl -X.STL \
            -X.sdf -X.skel -X.urdf -X.vsk -X.world \
            -X.c3d -X.changelog -X.dof -X.path -X.tris

execute_before_dh_link-indep:
	jdupes -rl debian/dart-doc/usr
